# 2025-08-16

## Node.js で Web サーバ作ってみる

### Node.js インストール

```bash
$ sudo apt update
$ sudo apt install -y nodejs npm
```

### https サーバを作る

#### サーバ証明書と秘密鍵の生成

```bash
$ openssl req -x509 -newkey rsa:2048 -noenc -keyout key1.pem -out cert1.pem -days 365 -subj "/C=JP/ST=Tokyo/L=Chiyoda/O=Example/OU=Dev/CN=192.168.90.224"
```

#### サーバ作成と起動

```
servers
  ┣━ cert1.pem
  ┣━ key1.pem
  ┗━ server1_1.js
```

```js
const https = require('https');
const fs = require('fs');

//--- 証明書と秘密鍵の読み込み
const options = {
  key: fs.readFileSync('key1.pem'),
  cert: fs.readFileSync('cert1.pem'),
};

//--- サーバ作成
https.createServer(options, (req, res) => {
  res.writeHead(200);
  res.end('Hello HTTPS!\n');
}).listen(8001, () => {
  console.log('HTTPS Server running at https://192.168.90.224:8001/');
});
```

```bash
$ node sever1_1.js &
```

#### 接続テスト

```bash
$ curl --insecure https://192.168.90.224:8001
Hello HTTPS!
```

ブラウザからも (警告ありで) 開けることを確認．

### 指定したパスのファイルを返すサーバを作る

#### サーバ作成と起動

```
servers
  ┣━ cert1.pem
  ┣━ key1.pem
  ┣━ server1_2.js
  ┣━ private.txt
  ┗━ public
      ┣━ html
      ┃   ┗━ page1.html
      ┗━ js
          ┗━ alert.js
```

```js
const https = require('https');
const fs = require('fs');
const path = require('path');

//--- 証明書と秘密鍵の読み込み
const options = {
  key: fs.readFileSync('key1.pem'),
  cert: fs.readFileSync('cert1.pem'),
};

//--- サーバ作成
https.createServer(options, (req, res) => {
  const requestedPath = decodeURIComponent(req.url);
  //--- パストラバーサル脆弱性
  const filePath = path.join(__dirname, 'public', requestedPath);
  const extension = path.parse(filePath).ext;
  let contentType = 'text/plain';
  switch (extension) {
    case '.html':
      contentType = 'text/html';
      break;
    case '.js':
      contentType = 'application/javascript'
      break;
  }

  fs.readFile(filePath, 'utf8', (err, data) => {
    if (err) {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      res.end('File Not Found.\n');
      return;
    }

    res.writeHead(200, {'Content-Type': contentType});
    res.end(data);
  });

}).listen(8001, () => {
  console.log('HTTPS Server running at https://192.168.90.224:8001/');
});
```
